# MCP chat troubleshooting (2025-12-21)

Status: historical notes; candidate for removal.

## Current status
- `tia-chat` MCP server now auto-builds a profile when `AGENT_PROFILE` is unset; it registers as `mcp-###` and joins `MUC_ROOM` (default `general@conference.tensegrity.it`).
- `autoConnectXmpp` temporary client is stopped before `XmppRoomAgent` starts to avoid XMPP resource conflict.
- `XmppRoomAgent` logs when sending group messages: `Sending group message to <room> as <nick>`.
- MCP server logs show registration/connect/join, but group messages still not visible in the room.
- Added buffering of incoming messages and a new MCP tool `getRecentMessages`.

## Files changed
- `src/mcp/servers/tia-mcp-server.js`
  - Default profile no longer `mistral`; random `mcp-###` profile built.
  - Stops auto-connect client before starting `XmppRoomAgent`.
  - Exposes `getRecentMessages` via MCP.
- `src/lib/xmpp-room-agent.js`
  - Logs when sending group message.
- `src/mcp/chat-adapter.js`
  - Records incoming messages into a ring buffer (default 50) and exposes `getRecentMessages`.
- `src/mcp/tool-definitions.js`
  - Adds `getRecentMessages(limit?)` MCP tool.

## Repro context
- MCP tool used: `sendMessage` with text (example: "Hello Chair").
- Registration logs example:
  - `Connected as mcp-583@tensegrity.it/mcp-583`
  - `Joining room general@conference.tensegrity.it as mcp-583`
  - `Joined room general@conference.tensegrity.it as mcp-583`
- Issue: no message appears in the MUC even though `sendMessage` returns `sent: true`.

## Next checks
- Restart MCP server to ensure updated code is running.
- Look for the send log line: `Sending group message to general@conference.tensegrity.it as mcp-###`.
- If the line is missing, the server is not on updated code.
- If the line is present but message still missing, inspect XMPP server logs / MUC permissions or stanza filtering.
- Use `getRecentMessages` to verify inbound messages are captured by MCP server.
