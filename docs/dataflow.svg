<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 1150" width="1200" height="1150">
  <defs>
    <style>
      .box { fill: #fff; stroke: #333; stroke-width: 2; }
      .agent { fill: #e3f2fd; }
      .coordinator { fill: #fff3e0; }
      .data { fill: #e8f5e9; }
      .executor { fill: #ffe0f0; }
      .room { fill: #f3e5f5; stroke-dasharray: 5,5; }
      .text { font-family: Arial, sans-serif; font-size: 14px; text-anchor: middle; }
      .title { font-size: 18px; font-weight: bold; }
      .phase { font-size: 12px; fill: #666; }
      .arrow { fill: none; stroke: #333; stroke-width: 2; marker-end: url(#arrowhead); }
      .data-arrow { stroke: #4caf50; stroke-width: 2; }
      .validation-arrow { stroke: #ff9800; stroke-width: 2; }
      .solution-arrow { stroke: #2196f3; stroke-width: 3; }
      .execution-arrow { stroke: #9c27b0; stroke-width: 2; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#333" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="600" y="30" class="text title">MFR (Model-First Reasoning) Dataflow</text>
  <text x="600" y="55" class="text phase">Drug Interaction Scheduling Example</text>

  <!-- User/Client -->
  <rect x="500" y="80" width="200" height="60" class="box" rx="5"/>
  <text x="600" y="115" class="text title">User/Client</text>

  <!-- Problem input -->
  <path d="M 600 140 L 600 180" class="arrow"/>
  <text x="700" y="165" class="text phase" text-anchor="start">"Schedule appointments, Alice takes warfarin..."</text>

  <!-- MUC Room (General) -->
  <rect x="450" y="180" width="300" height="80" class="box room" rx="5"/>
  <text x="600" y="210" class="text title">general@conference MUC Room</text>
  <text x="600" y="230" class="text phase">All agents listen here</text>

  <!-- Coordinator -->
  <rect x="480" y="290" width="240" height="80" class="box coordinator" rx="5"/>
  <text x="600" y="320" class="text title">Coordinator Agent</text>
  <text x="600" y="340" class="text phase">Orchestrates MFR protocol</text>
  <text x="600" y="355" class="text phase">Creates ProblemModel</text>

  <!-- Phase 1: Entity Discovery & Contribution -->
  <text x="100" y="420" class="text phase" text-anchor="start">PHASE 1: Entity Discovery</text>
  <path d="M 600 370 L 200 450" class="arrow data-arrow"/>
  <path d="M 600 370 L 450 450" class="arrow data-arrow"/>
  <path d="M 600 370 L 750 450" class="arrow data-arrow"/>
  <path d="M 600 370 L 1000 450" class="arrow data-arrow"/>

  <text x="350" y="410" class="text phase">Contribution Request</text>

  <!-- Agents -->
  <rect x="80" y="450" width="160" height="70" class="box agent" rx="5"/>
  <text x="160" y="480" class="text title">Mistral Agent</text>
  <text x="160" y="500" class="text phase">Extracts entities</text>

  <rect x="330" y="450" width="160" height="70" class="box data" rx="5"/>
  <text x="410" y="480" class="text title">Data Agent</text>
  <text x="410" y="500" class="text phase">Grounds in Wikidata</text>

  <rect x="630" y="450" width="160" height="70" class="box agent" rx="5"/>
  <text x="710" y="480" class="text title">Prolog Agent</text>
  <text x="710" y="500" class="text phase">Extracts actions</text>

  <rect x="880" y="450" width="180" height="70" class="box agent" rx="5"/>
  <text x="970" y="480" class="text title">MFR-Semantic</text>
  <text x="970" y="500" class="text phase">Extracts constraints</text>

  <!-- RDF Contributions -->
  <path d="M 160 520 L 550 590" class="arrow data-arrow"/>
  <path d="M 410 520 L 560 590" class="arrow data-arrow"/>
  <path d="M 710 520 L 610 590" class="arrow data-arrow"/>
  <path d="M 970 520 L 640 590" class="arrow data-arrow"/>

  <text x="280" y="560" class="text phase">RDF: 8 entities</text>
  <text x="520" y="560" class="text phase">RDF: grounded</text>
  <text x="760" y="560" class="text phase">RDF: 3 actions</text>
  <text x="960" y="560" class="text phase">RDF: constraints</text>

  <!-- Model Store -->
  <rect x="480" y="590" width="240" height="60" class="box coordinator" rx="5"/>
  <text x="600" y="615" class="text title">Model Store</text>
  <text x="600" y="635" class="text phase">Merges contributions + links to ProblemModel</text>

  <!-- Phase 2: Validation -->
  <text x="100" y="685" class="text phase" text-anchor="start">PHASE 2: Validation</text>
  <path d="M 600 650 L 600 710" class="arrow validation-arrow"/>

  <rect x="480" y="710" width="240" height="60" class="box coordinator" rx="5"/>
  <text x="600" y="735" class="text title">SHACL Validator</text>
  <text x="600" y="755" class="text phase">Validates completeness &amp; constraints</text>

  <text x="750" y="740" class="text phase" text-anchor="start">✓ 0 errors</text>
  <text x="750" y="760" class="text phase" text-anchor="start">⚠ 14 warnings</text>

  <!-- Phase 3: Reasoning -->
  <text x="100" y="805" class="text phase" text-anchor="start">PHASE 3: Constrained Reasoning</text>
  <path d="M 600 770 L 600 820" class="arrow solution-arrow"/>
  <path d="M 600 840 L 710 880" class="arrow solution-arrow"/>

  <rect x="630" y="880" width="160" height="70" class="box agent" rx="5"/>
  <text x="710" y="910" class="text title">Prolog Agent</text>
  <text x="710" y="930" class="text phase">Generates plan</text>

  <text x="780" y="920" class="text phase" text-anchor="start">Solution Proposal</text>

  <!-- Phase 4: Execution & Binding -->
  <text x="100" y="985" class="text phase" text-anchor="start">PHASE 4: Execution &amp; Binding</text>

  <!-- Executor Agent -->
  <path d="M 710 950 L 450 1000" class="arrow execution-arrow"/>
  <rect x="330" y="1000" width="160" height="70" class="box executor" rx="5"/>
  <text x="410" y="1030" class="text title">Executor Agent</text>
  <text x="410" y="1050" class="text phase">Requests bindings</text>

  <!-- Executor to Prolog for bindings -->
  <path d="M 490 1020 L 630 1020 L 710 970" class="arrow execution-arrow" stroke-dasharray="5,5"/>
  <text x="570" y="1010" class="text phase">Binding request</text>

  <!-- Prolog returns bindings to Executor -->
  <path d="M 710 950 L 710 990 L 490 1040" class="arrow execution-arrow"/>
  <text x="620" y="1060" class="text phase">Concrete bindings</text>

  <!-- Executor to Coordinator -->
  <path d="M 410 1070 L 520 1110" class="arrow execution-arrow"/>
  <text x="320" y="1100" class="text phase" text-anchor="start">Execution result</text>

  <!-- Final Coordinator -->
  <rect x="480" y="1110" width="240" height="0" class="box coordinator" rx="5" opacity="0"/>

  <!-- Legend -->
  <rect x="20" y="850" width="200" height="160" fill="#f9f9f9" stroke="#999" rx="3"/>
  <text x="120" y="870" class="text title">Legend</text>
  <line x1="30" y1="885" x2="80" y2="885" class="arrow data-arrow"/>
  <text x="90" y="890" class="text phase" text-anchor="start">RDF Data Flow</text>
  <line x1="30" y1="905" x2="80" y2="905" class="arrow validation-arrow"/>
  <text x="90" y="910" class="text phase" text-anchor="start">Validation</text>
  <line x1="30" y1="925" x2="80" y2="925" class="arrow solution-arrow"/>
  <text x="90" y="930" class="text phase" text-anchor="start">Solution</text>
  <line x1="30" y1="945" x2="80" y2="945" class="arrow execution-arrow"/>
  <text x="90" y="950" class="text phase" text-anchor="start">Execution</text>
  <rect x="30" y="960" width="50" height="20" class="box agent" rx="2"/>
  <text x="90" y="975" class="text phase" text-anchor="start">AI Agent</text>
  <rect x="30" y="985" width="50" height="20" class="box executor" rx="2"/>
  <text x="90" y="1000" class="text phase" text-anchor="start">Executor</text>
</svg>
